# test-panda-team

Описание тестового задания, состоящего из двух практических пунктов: создания Pipeline и настройки мониторинга.

## Пункт 1 – Создание Jenkins Pipeline

Для запуска Pipeline, в первую очередь, понадобится сам Jenkins с предустановленными базовыми плагинами. С Вашего позволения процесс установки пропущу, так как не это явялется основной темой. Также необходимо будет создать ряд секретов/учетных данных для успешной работы. Среди прочих это:

* Секрет типа Username with password для сохранения токена Github, так как в данном случае я решил использовать именно его, чтобы настроить доступ к репозиторию.

* Секрет типа Secret Text для указания IP-адреса конечного сервера

* Секрет типа SSH Username with private key для установления SSH-соединения с конечным агентом, на котором выполняется Pipeline

Чтобы создать токен для Github, необходимо перейти в настройки профиля > Developer Settings > Personal Access Token > Token Classic и там создать токен, указав его имя и срок жизни, а также уровень доступа к аккаунту.

Примечание: Более предпочтительным вариантом была бы настройка, как мне кажется, доступа через SSH, но этот вариант проще в рамках тестового задания. Этот комментарий я больше оставил потому, что хочу дать понять, что в курсе и об остальных вариантах интеграции между Jenkins и Github.

Все вышеупомянутые секреты можно создать и найти по пути Dashboard > Manage Jenkins > Credentials > System > Global credentials (unrestricted). Далее, поскольку код Pipeline лежит в самом репозитории (директория jenkins в корне), то для его запуска достаточно создать сам Pipeline с произвольным именем, открыть его настройки, спуститься вниз и в опции Definition выбрать Pipeline Script from SCM, что позволит нам использовать код, хранящийся в репозитории. Далее, ниже, нужно будет указать ссылку на репозиторий, а также секрет токена Github. Ещё чуть ниже нужно будет задать актуальную ветку (main) и путь к файлу (jenkins/webserver.groovy) в репе. В целом это будет выглядеть так:

![](https://i.imgur.com/aSAQemE.png)
![](https://i.imgur.com/nWrgWrc.png)

В моём случае я также настроил агента, на котором будет выполняться сам Pipeline. Но в контексте CI/CD более ничего не надо. Можно запускать. Возможно пайплайнне пройдет с первого раза, так как Jenkins нужно инициализировать код из файла в репозитории, поскольку у меня используется стринговый параметр. Это ок для него. Нужен повторный запуск будет просто и все. 

Примечание: В контексте самого Pipeline я создал три простых этапа, где у нас идет чекаут, сборка образа и типа деплой на сервер (самый простой вариант через SSH). По-хорошему должен был быть этап сборки, отправка образа в режистри и запуск композа с уже готовым образом из этого реджистри, но я не хотел усложнять и обременяться дополнительными сервисами или службами, поэтому вот так. Ну и в post добавил ради приличия очистку от предыдущих действий в контексте Docker, поскольку якобы деплой идет туда же, где и сам агент (по ресурсам и виртуалкам я ограничен).


## Пункт 2 – Запуск системы мониторинга

Тут всё проще. Запускаем композ файл из директории Monitoring с помощью следующей команды:

```
docker compose up -d
```

И ожидаем какое-то время. Если возникнут какие-либо проблемы (обычно с правами на файлы часто бывает), то для директории `./monitoring/grafana/data` нужно будет выполнить команду:

```
sudo chown -R 472:472 ./monitoring/grafana/data
```

А для Prometheus директории по пути `./monitoring/prometheus/data` нужно будет выполнить эту команду:

```
sudo chown -R 1000:1000 ./monitoring/grafana/data
```

И запускаем композ ещё раз с помощью:

```
docker compose up -d --force-recreate
```

У меня во всяком случае при запуске проблем больше не было. Далее можно открывать Grafana по пути `http://yourip:3000`. Дефолт для входа это `admin:admin`, после чего предложат поменять пароль. Когда вошли, необходимо будет перейти в секцию Connection и настроить Prom в качестве Data Source. Указываем ендпоинт либо айпишника сервера, так как пром на 0.0.0.0 запущен, либо имя сервиса (в данном случае prometheus) и порт. То есть, например: `http://yourip_or_compose_name:9090` и нажимаем сохранить / проверить соединение. После идем в дашборды, создаем новый, открываем настройки и ищем import dashboards. Открываем окно и вставляем код дашборда, который хранится по пути `./monitoring/dashboards`

Примечание: Я думаю так будет проще и нагляднее, но на всякий случай я сделал скрины и положил их в директорию screenshots в том же мониторинге. 

Импортируем и сохраняем. После этого всё должно было подтянуться. Делаем тоже самое ещё раз уже для кадвизор дашборда (который мониторит контейнеры). Файл в виде кода в JSON лежит там же. Это что касается мониторинга. По алертингу -- нажимаем на три точки возле любого тайтла и выбираем там пункт Create Alert. Нас сразу перебросит в секцию алертов с текущим нажим запросом в promQL. Тут я не знаю насколько подробно надо расскаызвать, что да как там устроено, если в двух словах, то выбираем уровень отметки когда алерт сработает, указываем на запрос, для которого алерт будет работать, указываем группу и время реагирования и можно указать куда оптравлять алерт. В общем всё очень просто. Вроде бы и всё.
